---
title: "Distribution of Fire Risk Over Time"
author: "Hannah Gorman"
date: "December 3, 2017"
output: html_document
---
##Introduction

I'm volunteering with the San Francisco Brigade Data Science Working Group,
where I'm working on visualizing our model of fire risk. In addition to creating
a map to display our predicted risks, I wanted to explore the dataset and see
if I can find any instances of (near-) perfect correlation between input variables
and model outputs, to help us make the case for our model's validity. To start,
I will explore individual variables and their relationships. Because the dataset
is pretty large (200,000 observations), I created a sampling function to help
me make plots quickly before applying them to the entire dataset.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,messages=FALSE,warnings=FALSE)

setwd('/Users/hgorman/Desktop/code_for_america')

dat = read.csv("fire_incident_master_20170906.csv")
dat <- data.frame(dat)

library(ggplot2)
library(tidyr)
library(dplyr)
library(gridExtra)
library(lattice)
library(MASS)
library(ggmap)

``` 

```{r,echo=TRUE}

  # Function to sample 10,000 addresses from data set to make plotting quicker.
  # Note that the function will select all observations for a given address,
  # so the sample size will generally be > 10,000
  # Final plots will include all data.

resample <- function(df) {
  df <- as.data.frame(df)
  sample_adresses <- 
    sample(levels(as.factor(df$Address)),size=10000,replace=FALSE)
  sample <- df[which(df$Address %in% sample_adresses),]
  return(sample)
}

```

##Exploring influential variables
I'll start with three variables we found had high influence in our random forests 
model of fire risk: land value, number of units, and year built.

Question one: how are land values related to the year in which 
properties were built? 

```{r,echo=FALSE,warnings=FALSE,messages=FALSE}

land_val_year_boxplot <- 
  ggplot(data=resample(dat),
         aes(x=as.ordered(cut(Yr_Property_Built,seq(1880,2020,5))),
             y=log(Land_Value))) +
  geom_boxplot()

# Faint sin pattern when we cut by decade.
# Square root transformation of land value shows this more clearly,
# along with excluding outliers

year_value_plot <- 
  ggplot(data=dat,
         aes(y=Land_Value,x=Yr_Property_Built)) +
  geom_point(alpha=1/25,position=position_jitter()) +
  scale_y_sqrt() +
  scale_x_continuous(breaks=seq(1880,2020,10)) +
  theme_classic() +
  ggtitle("Sqrt of Property Value vs. Year Built and Fire Risk") +
  coord_trans(limy=c(0,5000000)) +
  stat_smooth()

grid.arrange(land_val_year_boxplot,year_value_plot)
cor.test(dat$Land_Value,dat$Yr_Property_Built)

```

Boxplots of sampled landvalue by decade show a faint sin pattern in the log land 
value of new buildings. This wave pattern is also apparent when we look at the 
square root of land value year over year in a scatterplot. This wave seems to be
related to periodic peaks in the years 1900 to 1960, where we also see a
pattern of *density* of points (aka number of buildings built). Instead of a
pattern in land value, could this pattern correspond simply to the number of 
buildings built each year, meaning that both land values and number of buildings
are reflecting the strenght of the real estate market?

```{r, echo=FALSE,warnings=FALSE,messages=FALSE}

  # How much is the cycical pattern related to how many
  # building are built each year?

building_plot <- ggplot(data=resample(dat),aes(x=Yr_Property_Built)) +
  geom_histogram(binwidth=1) +
  scale_x_continuous(breaks=seq(1880,2020,10)) +
  theme_classic()

  # Outlier in 1900--a year used to code unknown years in the 19th century.
  # From here on out, use dat2, which excludes 1900

dat2 <- subset(dat,dat$Yr_Property_Built>1900)

building_plot2 <- 
  ggplot(data=resample(dat2),aes(x=Yr_Property_Built)) +
  geom_histogram(binwidth=1) +
  scale_x_continuous(breaks=seq(1880,2020,10)) +
  theme_classic()

grid.arrange(building_plot,building_plot2)
```

Looking only at data since 1900 (since 1900 was often used as the year for 
buildings with unknown dates of construction), we see an approximate normal 
distribution across each decade or so--we can call these real estate 
business cycles. We also see a precipitous drop in the number of properties built 
since 1950, though the normal distributions pattern continues into later decades.

We can hypothesize that as San Francisco became more dense and built up, less 
land was available for building projects. Sometime around the 1950s and 1960s,
the number of new building projects fell to a new equilibrium of less that 100
new buildings a year.

Looking back at the plot of sqrt of land values year over year however, we see
the pattern beginning to break down around the year 2000. The dense blocks 
representing normal distributions become less clear, and land values begin to
increase in what looks more like an exponential pattern. Could other factors
be changing?

```{r,echo=FALSE}

  # Break down land value by quintile, see how proportion changes over time

dat2$land_val_decile <- cut(dat2$Land_Value,quantile(dat2$Land_Value,probs=
                                                       seq(0,1,.15)))
summary(dat2$land_val_decile)

building_plot3 <- 
  ggplot(data=subset(dat2,!is.na(land_val_decile)),
                         aes(x=Yr_Property_Built)) +
  geom_freqpoly(aes(color=land_val_decile),binwidth=2) +
  coord_trans(limx=c(1900,2015)) +
  scale_color_brewer(palette='PuBuGn') +
  theme_classic()

building_plot3
```

Plotting property values by decile shows that along with a big drop in the rate 
of new buildings since the 50s, the value of the land on which new
properties do get built is higher. This is likely due to inflation and rising SF 
property rates. Another possibility is increases in multiunit dwellings, since
bigger plots will have higher values. Let's see if this is the case:

```{r,echo=FALSE}

year_units_plot <- 
  ggplot(data=subset(dat2,dat2$Num_Units>0),
         aes(y=Num_Units,x=Yr_Property_Built)) +
  geom_line(stat='summary',fun.y=mean) +
  geom_line(stat='summary',fun.y=median, color='blue') +
  theme_classic() +
  scale_x_continuous(breaks=seq(1900,2020,10)) +
  scale_y_continuous(breaks=seq(0,40,1)) +
  coord_trans(limy=c(0,40),limx=c(1900,2020))

year_units_plot
```

While this isn't the prettiest plot, we get an initial sense of variation in the
number of multi-unit buildings being built each year. We see big spikes in the 
number of units per dwelling throughout the last 115 years, but the number of 
spikes have increased quite a bit since 1960, and especially since 1990. These 
spikes represent years in which buildings with a lot of units pulled up the averages
(e.g. 1983, when the mean, black, spikes but not the median, blue) or where the 
proportion of buildings with many units incresaed a lot (years like 1999, when 
both mean and median spike). This suggests that there are more, bigger multi-unit
buildings since the late 90s. 

In addition, we have a measurement, land value per square foot. Plotting this
measurement will show us whether land value has gone up irrespective of lot size,
too.

```{r,echo=FALSE}
  # Land value per square foot by year

building_plot4 <- 
  ggplot(data=resample(dat2),
         aes(y=landval_psqft,x=Yr_Property_Built)) +
  geom_point(alpha=1/15,position=position_jitter()) +
  scale_x_continuous(breaks=seq(1900,2020,10)) +
  theme_classic()

  # Create a variable for decade, then a table of mean/median/IQR of landval_psqft

dat2$decade <- cut(dat2$Yr_Property_Built,seq(1900,2020,10),labels=seq(1900,2015,10))

landval_by_decade <- dat2 %>%
  group_by(dat2$decade) %>% 
  summarise(mean = mean(landval_psqft), 
            median = median(landval_psqft),
            IQR = IQR(landval_psqft)) %>% 
  gather(key = 'metric', value = 'measurement', mean, median, IQR)

colnames(landval_by_decade) = c('decade','metric','measurement')

  # Plot mean/median/IQR of landval_psqft

building_plot5 <- 
  ggplot(data=landval_by_decade,
         aes(x=as.numeric(decade),y=measurement,color=metric)) +
  geom_line() +
  scale_x_continuous(breaks=seq(1,12,1),labels = seq(1900,2015,10)) +
  theme_classic() +
  xlab("decade")

  # Arrange plots

grid.arrange(building_plot4,building_plot5)

  # Get statistics of landval_psqft by decade 

by(dat2$landval_psqft,cut(dat2$Yr_Property_Built,seq(1900,2015,10)),summary)

```

Looking at land value per squarefoot, we see clearly that there has been 
anomalous behavior in the value of land on which new properties are built
since 1980. The mean, median, and interquartile range has increased 
exponentatially and is higher than at any other point in the last 140 years. 
In addition, the IQR and the mean have gotten closer together. This means that 
the mean is increasing faster than variability--so landvalues are getting
more concentrated over time.

```{r,echo=FALSE}

ggplot(data=dat2,aes(x=Yr_Property_Built,y=Num_Units,color=sqrt(landval_psqft))) +
  geom_point(alpha=.85,position=position_jitter()) +
  scale_color_gradientn(colours=c('#ff99cc','#33ccff')) +
  theme_classic() +
  scale_x_continuous(breaks=seq(1900,2020,10)) +
  coord_trans(limy=c(0,100))

```

So far, we've explored two trends in recent decades: increasing landvalues for 
new properties, and more spikes in multiunit dwellings. This plot strongly 
suggests that the two trends are independent, or at least not strong covariates.
Plots with high value per squarefoot seem pretty equally distributed among 
buildings with few or many units. Since these two factors were very important
for our model of fire risk, it's good news that while we see trends in each
over time, we don't see a strong relationship between the two.

On the other hand, both variables are definitely related to year. We found year
to be an important predictor of risk--older houses tended to have higher risk
factors. While this makes intuitive sense, the model may be overly sensitive
to the fact that there are *more older houses*, and that newer houses tend to
be on *higher-value lots*. This could lead our model to give old houses a 
too-high risk score and increase our false positive rate (specificity). While we
worry more about false negatives than false positives, we don't want our model
output to say something like, "any house built before 1950 has a 99% likelihood 
of a fire incident!" 

If this is the case, we may want to start changing our sampling method for model
building to better account for the panel format of our data. So how is predicted 
risk distributed among house by age, and for that matter by 
lot value, and by the number of units?

##Exploring predicted fires across influential variables

Our predicted risk factor is stored in the variable Incident_Dummy. 

```{r,echo=FALSE,warnings=FALSE,message=FALSE}

  #sf coords: 37.7749° N, 122.4194° W

sf <- get_map(location=c(lon=-122.419,lat=37.775),zoom=12)

lat_lon_fun <- function(df) {
  
  lat_lon <- as.character(df$Location_y)
  df <- df[,!names(df) %in% list('Location_y')]
  lat_lon <- as.vector(sapply(lat_lon,
               function(x) gsub(pattern='\\(|\\)|\\,',replace="",x)))
  df <- cbind(lat_lon,df)
  df <- separate(df, lat_lon, into=c('lat','lon'), sep = '[:space:]')
  return(df)
}

dat2 <- lat_lon_fun(dat2)

ggmap(sf) +
  geom_point(aes(x=as.numeric(lon),y=as.numeric(lat),color=as.numeric(Yr_Property_Built)),
             data=subset(resample(dat2),Incident_Dummy==1), alpha=.8) +
  scale_color_distiller(type='div')

p <- list()

for (i in 1:10){
  samp <- subset(resample(dat2),Incident_Dummy==1)
  p[[i]] <-
    ggmap(sf) + 
      geom_point(aes(x=as.numeric(lon),y=as.numeric(lat),
                color=as.numeric(Yr_Property_Built)),data=samp, alpha=.8) +
      scale_color_distiller(type='div')
}

```
Proportion of fires per building year of construction:
