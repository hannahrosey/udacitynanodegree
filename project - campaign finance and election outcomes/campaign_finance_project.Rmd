---
title: "exploratory data analysis project - campaign finance"
author: "Hannah Gorman"
date: "January 22, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
setwd('/Users/hgorman/Desktop/udacity_nanodegree/project - campaign finance and election outcomes')
library('tidyr')
library('dplyr')
library('ggplot2')
library('gridExtra')
```

## Introduction

In this project for the Udacity data analysis nanodegree, I'm going to explore 
the influence of campaign contributions on 2014 congressional election outcomes. 
The data on campaign contributions is from the federal elections commission. 

I will use three primary measures of campaign finance: dollars per campaign, 
average campaign contribution size, and % of opponent spend.

Along with win/loss, I will look at vote share as a continuous outcome variable. 
I will cut the data by candidate party (dem/rep/ind), state, and contributor type 
(PAC vs. individual) to see if trends in the impact of campaign finance vary 
based on these election attributes.

### Tasks

  * Visualize $ contributed
      * histogram of dollars/campaign colored by dem/rep/ind
      * boxplot of dollars/campaign by state
  * Visualize dollars contributed by win/loss
      * scatterplot of vote share vs. dollars
        ** add win/loss line
        ** color dem/rep/ind
        ** facetwrap by state
      * scatterplot of vote share vs. average contribution size
        * add win/loss line
        * color dem/rep/ind
        * facetwrap by state
        * facetwrap by contributor type

## Read In and Data Preparation
```{r, echo=FALSE}
finance <- read.csv('campaign_finance_clean_data.csv')
finance <- finance[!names(finance) %in% 'X']
str(finance)
finance$TRANSACTION_DATE <- as.Date(finance$TRANSACTION_DATE,format='%Y-%m-%d')

outcomes <- read.csv('election_outcomes_clean_data.csv')
outcomes <- outcomes[!names(outcomes) %in% 'X']
str(outcomes)

overlap <- intersect(finance$CAND_ID,outcomes$CAND_ID)
```

The two datasets overlap for ```r length(overlap)``` candidates.

```{r,echo=FALSE}

    # clean finance and outcome data available for 265 candidates from 2014 
    # midterm elections

finance_agg <- 
  finance %>% 
  group_by(CAND_ID,CAND_NAME,CAND_PARTY,CAND_STATE,CAND_DISTRICT,CAND_RACE_STATUS) %>% 
  summarise(TOTAL_CONTRIBUTIONS = sum(TRANSACTION_AMOUNT),
            MEAN_CONTRIBUTION_AMOUNT = mean(TRANSACTION_AMOUNT),
            FIRST_CONTRIBUTION = min(TRANSACTION_DATE),
            NUMBER_OF_CONTRIBUTIONS = n())

df = inner_join(finance_agg,outcomes,by=as.character('CAND_ID'))
df$STATE_DISTRICT <- paste(df$CAND_STATE,'-',df$CAND_DISTRICT,sep='')

df$CHAMBER <- substr(df$CAND_ID,1,1)

tail(finance_agg)

```

### Wins and Losses by Party
```{r, echo=FALSE}
party_hist <- ggplot(data=df,aes(x=VOTESHARE,fill=CAND_PARTY)) + 
  geom_histogram(binwidth=5) + 
  scale_fill_brewer(type='qual',palette='Spectral',direction=-1) +
  geom_vline(xintercept=50,size=.2) +
  theme_classic() +
  xlab('Voteshare') +
  ylab('# Candidates')

party_hist
```

Let's break this out by candidate status: challenger (C), incumbent (I), 
or open race (O)

```{r,echo=FALSE}
candidate_status <- ggplot(data=df,aes(x=VOTESHARE,fill=CAND_PARTY)) + 
  geom_histogram(binwidth=3) + 
  scale_fill_brewer(type='qual',palette='Spectral',direction=-1) +
  geom_vline(xintercept=50,size=.2) +
  theme_classic() +
  xlab('Voteshare (%)') +
  ylab('Candidates (#)') + 
  facet_wrap(~CAND_RACE_STATUS) 

candidate_status
```

Let's also break things out by state in cases where a state has a significant 
number of races, e.g. 10 or more.

```{r, echo=FALSE}
many_race_states = subset(
  as.data.frame(sort(table(df$CAND_STATE),decreasing=TRUE)),
  Freq>10)

candidate_state <- 
  ggplot(data=subset(df,df$CAND_STATE %in% many_race_states$Var1),
         aes(x=VOTESHARE,fill=CAND_PARTY)) + 
  geom_histogram(binwidth=1) + 
  scale_fill_brewer(type='qual',palette='Spectral',direction=-1) +
  theme_classic() +
  geom_vline(xintercept=50) +
  facet_wrap(~CAND_STATE)  +
  xlab('Voteshare (%)') +
  ylab('Candidates (#)')

candidate_state
```

From this initial visualization, I notice that our dataset is a little unbalanced.
The dataset includes slightly more data on winning candidates (>50% of voteshare) 
than on losing candidates (<50% of voteshare). This is likely due to the fact that 
campaign contribution data was incomplete. Candidates in the outcomes dataset with 
verysmall (<1%) voteshare were also frequently bundled into the category "Scattered." 
This biases both datasets somewhat towards winning candidates; we can also see
this impact in a boxplot, or when we table our data by chamber and win/loss:

```{r,echo=TRUE}
#Table of Chamber of Win/Loss Observations
table(df$CHAMBER,df$WIN_LOSS)

```

```{r, echo=FALSE}
candidate_status_box <- ggplot(data=df,aes(y=VOTESHARE,x=CAND_RACE_STATUS)) + 
  geom_boxplot() +
  theme_classic() +
  ylab('Voteshare (%)') +
  xlab('Race Type') +
  geom_hline(yintercept=50,size=.2)

candidate_status_box

```

The limitation of missing candidates means that this dataset may not be ideal
for causal questions--i.e., predicting what causes a candidate to win or lose.
The approximately normal distribution we see in the above histogram is most likely
due to the data we've chosen. If we had data on more candidates per race, we would 
likely see much more skewed data, with most candidates falling below 50% voteshare.

Even given this limitation in linking voteshare and contribution data, 
we can find some interesting patterns.

The candidate status breakout shows us that the mean voteshare for challengers
is much lower than that for incumbents, while open races (the least common type)
have a center of about 50%. We can examine this trend further by coloring
our histogram by win/loss instead of party, since in a race with more than 2 
candidates, a voteshare of less than 50% may be sufficient to win:

```{r, echo=FALSE}

candidate_status_wl <- ggplot(data=df,aes(x=VOTESHARE,fill=as.factor(WIN_LOSS))) + 
  geom_histogram(binwidth=1) + 
  geom_vline(xintercept=50,size=.2) +
  theme_classic() +
  xlab('Voteshare (%)') +
  ylab('Candidates (#)') + 
  facet_wrap(~CAND_RACE_STATUS)

candidate_status_wl
```

As this histogram shows, winning candidates were almost all incumbents
and losing candidates were almost all challengers. Given the strength of this
covariance in this dataset, it may actually be more interesting to examine 
differences between incumbents and challengers rather than winners and losers.
The contribution dataset can shed light on the material differences between these
types of candidates.

This prompts some questions, which we can answer using the aggreggated
finance dataset:

  * Do incumbents receive larger contributions, or more contributions, or 
  contributions earlier in the cycle due to their name recognition? 
  * Within the group of winning incumbents, do factors like state, party, and 
  chamber have an impact on candidates' voteshare? 
  *E.g., do incumbent republicans win by more than incumbent democrats? Vis versa?*
  * What outliers do we see--incumbents who lost, or challengers who won? 
  Can we learn more about these candidates' circumstances or strategies?
  
## Incumbents vs. Challengers

### Contribution Patterns

#### Do incumbents receive larger contributions?

A first intuition about the differences between incumbents and challengers is 
that incumbents raise significantly more overall than challengers. We can start 
by looking at patterns in the sum of all contributions in the campaign finance
dataset:

```{r, echo=FALSE}

contribution_hist <- ggplot(data=finance_agg,aes(x=TOTAL_CONTRIBUTIONS,fill=CAND_RACE_STATUS)) +
  geom_histogram(binwidth=.25) +
  scale_fill_brewer(palette='Spectral') +
  theme_classic() +
  ylab('Candidates (#)') +
  xlab('Log of Total Contributions ($)') +
  scale_x_log10()

contribution_box <- ggplot(data=finance_agg,aes(x=CAND_RACE_STATUS,y=TOTAL_CONTRIBUTIONS)) +
  geom_boxplot() +
  theme_classic() +
  xlab('Race Type') +
  ylab('Log of Total Contributions ($)') +
  scale_y_log10()

grid.arrange(contribution_hist,contribution_box,nrow=2)

```

These plots support the hypothesis that incumbents receive more contributions
overall by several orders of magnitude: the median aggregate contributions to
challenger candidates is around $1,000 (with a big spread) compared to a median 
of $100,000 for incumbent candidates. 

Interestingly, the median contribution for open races is closer to that of 
incumbents. This suggests that it might not just be that incumbents have an edge
in fundraising, but that they specifically deter people from giving to challengers. 

This could also be an effect of districts that consistently favor a certain party, 
since most commonly a challenger is from a different party than the incumbent.

### Do incumbents receive more contributions?

We can also check out the size of the **mean** contribution candidates received.
This may shed light on what kinds of donors lead to this big fundraising advantage
for incumbents:
```{r, echo=FALSE}

contribution_mean_hist <- ggplot(data=finance_agg,aes(x=MEAN_CONTRIBUTION_AMOUNT,fill=CAND_RACE_STATUS)) +
  geom_histogram(binwidth=.075) +
  scale_fill_brewer(palette='Spectral') +
  theme_classic() +
  ylab('Candidates (#)') +
  xlab('Log of Mean Contributions ($)') +
  scale_x_log10(breaks=c(seq(0,2000,2000),seq(20000,150000,100000)),limits=c(300,150000))

contribution_mean_box <- ggplot(data=finance_agg,aes(x=CAND_RACE_STATUS,y=MEAN_CONTRIBUTION_AMOUNT)) +
  geom_boxplot() +
  theme_classic() +
  xlab('Race Type') +
  ylab('Log of Mean Contributions ($)') +
  scale_y_log10()

grid.arrange(contribution_mean_box,contribution_mean_hist,nrow=2)

```

These plots show us that the type of race a candidate runs doesn't seem to 
determine how big their average campaign contribution is. This may have to do
with the underlying data: while cleaning the campaign finance dataset, I 
observed that entities frequently 'batched' many small contributions (e.g., 40
contributions of 500 dollars each instead of giving 20k). We can manipulate the 
dataset in order to compare:

```{r, echo=TRUE}

finance_by_committee <- finance %>% 
  group_by(CAND_ID,CAND_RACE_STATUS,COMMITTEE_ID) %>% 
  summarise('COMMITTEE_TOTAL_CONTRIBUTIONS'=sum(TRANSACTION_AMOUNT))

head(finance_by_committee)

  # each row in this dataframe represents the total amount a given political
  # action committee (PAC) gave to a given candidate in the 2014 election.
  
committee_histogram <- 
  ggplot(data=finance_by_committee,aes(x=COMMITTEE_TOTAL_CONTRIBUTIONS,fill=CAND_RACE_STATUS)) +
  geom_histogram(binwidth=.25) +
  scale_fill_brewer(palette='Spectral') +
  theme_classic() +
  ylab('Candidates (#)') +
  xlab('Log of Total Contributions ($)') +
  scale_x_log10()

committee_box <- 
  ggplot(data=finance_by_committee,aes(x=CAND_RACE_STATUS,y=COMMITTEE_TOTAL_CONTRIBUTIONS)) +
  geom_boxplot() +
  theme_classic() +
  xlab('Race Type') +
  ylab('Log of Total Contributions ($)') +
  scale_y_log10()

grid.arrange(committee_histogram,committee_box,nrow=2)

```

Looking at the underlying finance data confirms that while there are many *more*
transactions from PACs to incumbents than open race candidates and 
especially than challengers, how much they give a candidate whom they do support
does not vary based on incumbency.

### Do incumbents receive contributions earlier?

Since the number rather than the size of contributions seems to matter,
we can further quantify the difference in the **number of contributions** a 
candidate receives based on incumbancy status.

```{r, echo=FALSE}

n_contributions_hist <- 
  ggplot(data=finance_agg,aes(color=CAND_RACE_STATUS,x=NUMBER_OF_CONTRIBUTIONS)) +
  geom_freqpoly(binwidth=10) +
  theme_classic() +
  scale_x_continuous(limits=c(2,1000)) +
  xlab('Number of contributions') +
  ylab('Candidates (#)')

n_contributions_hist

by(finance_agg$NUMBER_OF_CONTRIBUTIONS,finance_agg$CAND_RACE_STATUS,summary)

```

The histogram and summary of contributions by race type suggest that an incumbent
gets 5 times as many contributions as a challenger and 3-4 times as many times as
a candidate in an open race. 

#### Do incumbents receive contributions earlier in the cycle?
Another possible source of incumbent advantage may be that funders identify the
candidate earlier in the race than a challenger. If this is the case, it could
impact challenger fundraising strategies.

```{r, echo=FALSE}

first_contribution_hist <- 
  ggplot(data=subset(finance_agg,!is.na(finance_agg$FIRST_CONTRIBUTION)),
         aes(x=FIRST_CONTRIBUTION,fill=CAND_RACE_STATUS)) +
  geom_histogram(binwidth=5) +
  theme_classic() +
  xlab('Date of First Contribution') +
  ylab('Candidates (#)')

first_contribution_hist

```

This plot of first contribution date sheds a really interesting light on the
disparity between incumbent and challenger fundraising. It shows that 
incumbents may get more contributions simply because they start earlier, or even 
if candidates start fundraising at the same time, an incumbents' greater name 
recognition may give them an edge in fundraising years in advance. 

It's also likely that money spent earlier in a campaign is more effective: 
reaching your voter earlier than your competitor through ads, etc. may carry a 
significant advantage. 

It's even possible that when a PAC contributes influences the size of their gift.
To do this, I will use the original campaign finance dataset--in which individual 
contributions, rather than candidates, were the unit of analysis:

```{r, echo=TRUE}
str(finance)

contribution_size_over_time <- 
  ggplot(data=finance,
         aes(x=TRANSACTION_DATE,y=TRANSACTION_AMOUNT,color=CAND_RACE_STATUS)) +
  geom_point(position=position_jitter(),alpha=1/2) +
  scale_y_log10() +
  theme_classic()

contribution_size_over_time

```

The plot of contribution size over time shows clear horizontal bars that suggest
common contribution 'tranches,' such as $1,000. Around July of the election year,
the number of contributions increseases (points are denser) and the spread increases:
there are more big contributions, but the biggest increase is in small contributions
(under $1,000).

We can't tell from this data which kind of late-cycle contribution is better--
lots of small donations or an equivalent big infusion of cash--but it is clear 
that challengers and open race contestants are missing out on years of slow and
steady contributions available to incumbents.


### 
  